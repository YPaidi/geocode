<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaflet Timeline (Companies • CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- PapaParse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { height:100%; margin:0; }
    #map { height:100vh; }
    .topbar {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: white; padding: 8px 10px; border-radius: 8px; box-shadow:0 1px 4px rgba(0,0,0,.25);
      font: 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; gap:8px; align-items:center; flex-wrap: wrap;
    }
    .timeline-control {
      background: white; padding: 10px 12px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      font: 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial; width: 340px;
    }
    .timeline-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .timeline-row input[type="range"] { flex:1; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-weight:600; }
    .mode { margin-top:6px; font-size:12px; display:flex; gap:10px; }
    .legend { background:white; padding:8px 10px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,.25);
      font: 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .legend-item { display:flex; align-items:center; gap:6px; margin-top:4px; }
    .legend-swatch { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .hidden { display:none; }
    button, input[type="file"] { font: inherit; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>Dataset:</strong>
    <code>data.csv</code>
    <button id="btnReload" title="Reload data.csv">Reload</button>
    <span id="status" aria-live="polite"></span>
    <!-- Fallback loader (optional): will appear if fetch fails) -->
    <input id="file" type="file" accept=".csv" class="hidden" />
  </div>
  <div id="map"></div>

  <script>
    // ---------------------------
    //  MAP BASE
    // ---------------------------
    const map = L.map('map', { zoomControl: true }).setView([4.5, 108], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const layer = L.layerGroup().addTo(map);

    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    // Show file picker only when running locally (file:// or localhost)
    const IS_LOCAL = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
    const ENABLE_FILE_PICKER = IS_LOCAL;

    function colorByDecade(year){
      if(!year) return '#666';
      const d = Math.floor(year/10)*10;
      if (d < 1970) return '#6366f1';
      if (d < 1980) return '#22c55e';
      if (d < 1990) return '#06b6d4';
      if (d < 2000) return '#f59e0b';
      if (d < 2010) return '#ef4444';
      if (d < 2020) return '#a855f7';
      return '#0ea5e9';
    }

    // ---------------------------
    //  TIMELINE CONTROL
    // ---------------------------
    const TimelineControl = L.Control.extend({
      onAdd: function() {
        const div = L.DomUtil.create('div', 'timeline-control');
        const thisYear = new Date().getFullYear();
        div.innerHTML = `
          <div><strong>Timeline</strong></div>
          <div class="timeline-row">
            <button id="btnPlay" title="Play/Pause">▶</button>
            <input id="yearSlider" type="range" min="1950" max="${thisYear}" step="1" value="1950">
            <span class="pill" id="yearLabel">1950</span>
          </div>
          <div class="mode">
            <label><input type="radio" name="mode" value="cumulative" checked> Cumulative (≤ year)</label>
            <label><input type="radio" name="mode" value="point"> Point-in-time (= year)</label>
          </div>`;
        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.disableScrollPropagation(div);
        return div;
      }
    });
    const ctrl = new TimelineControl({ position: 'topright' });
    map.addControl(ctrl);

    const yearSlider = () => $('yearSlider');
    const yearLabel  = () => $('yearLabel');
    const modeInputs = () => Array.from(document.querySelectorAll('input[name="mode"]'));
    const btnPlay    = () => $('btnPlay');
    function currentMode(){ const r = modeInputs().find(i => i.checked); return r ? r.value : 'cumulative'; }

    let markersAll = [];
    function render(year){
      yearLabel().textContent = year;
      layer.clearLayers();
      const isCum = currentMode()==='cumulative';
      for(const m of markersAll){
        if(!m.__year) continue;
        const show = isCum ? (m.__year <= year) : (m.__year === year);
        if(show) layer.addLayer(m);
      }
      if(layer.getLayers().length) map.fitBounds(layer.getBounds(), {padding:[20,20]});
    }
    yearSlider().addEventListener('input', e => render(+e.target.value));
    modeInputs().forEach(inp => inp.addEventListener('change', () => render(+yearSlider().value)));

    let playing=false, timer=null;
    function togglePlay(){
      if(!playing){
        playing=true; btnPlay().textContent='⏸';
        timer=setInterval(()=>{
          let y=+yearSlider().value;
          y = (y >= +yearSlider().max) ? +yearSlider().min : y+1;
          yearSlider().value=y; render(y);
        },800);
      } else { playing=false; btnPlay().textContent='▶'; clearInterval(timer); }
    }
    btnPlay().addEventListener('click', togglePlay);

    // Legend
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `<b>Decade</b>
        <div class="legend-item"><span class="legend-swatch" style="background:#6366f1"></span> ≤1960s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#22c55e"></span> 1970s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#06b6d4"></span> 1980s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#f59e0b"></span> 1990s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#ef4444"></span> 2000s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#a855f7"></span> 2010s</div>
        <div class="legend-item"><span class="legend-swatch" style="background:#0ea5e9"></span> 2020s+</div>`;
      return div;
    };
    legend.addTo(map);

    // ---------------------------
    //  DATA LOADING (CSV)
    // ---------------------------
    const REQUIRED_COLUMNS = ["Company Name","YearEstablished","Latitude","Longitude"]; // soft-checked

    function pick(obj, keys){
      // Try exact names first
      for (const k of keys) { if (Object.prototype.hasOwnProperty.call(obj, k)) return obj[k]; }
      // Then case-insensitive/trimmed; strip BOM if present
      const norm = {};
      Object.keys(obj).forEach(k => { norm[k.trim().toLowerCase().replace(/^﻿/, '')] = obj[k]; });
      for (const k of keys) { const v = norm[k.trim().toLowerCase()]; if (v !== undefined) return v; }
      return "";
    }

    function buildMarkers(rows){
      let built = 0;
      markersAll = rows
        .map(r => {
          const name = pick(r, ["Company Name","CompanyName","Name"]);
          const yRaw = pick(r, ["YearEstablished","Year","Established"]);
          const year = (typeof yRaw === 'number') ? yRaw : parseInt(String(yRaw).trim(), 10);
          const latStr = String(pick(r, ["Latitude","geo.Latitude","Lat","lat"]).toString()).replace(/,/g, '.');
          const lngStr = String(pick(r, ["Longitude","geo.Longitude","Long","Lng","lon","lng"]).toString()).replace(/,/g, '.');
          const lat  = parseFloat(latStr);
          const lng  = parseFloat(lngStr);
          const addr = pick(r, ["Address_1Line","MatchedAddress","Address","addr"]);
          if (!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return null;
          built++;
          const m = L.circleMarker([lat, lng], { radius: 6, weight: 1, color: '#222', fillColor: colorByDecade(year), fillOpacity: 0.9 })
            .bindTooltip(`${name} (est. ${Number.isFinite(year) ? year : '—'})`, {direction:'top', offset:[0,-2]})
            .bindPopup(`<b>${name}</b><br/>Established: ${Number.isFinite(year) ? year : '—'}${addr ? '<br/>'+addr : ''}`);
          m.__year = Number.isFinite(year) ? year : null;
          return m;
        })
        .filter(Boolean);

      const years = markersAll.map(m => m.__year).filter(y => y);
      const min = years.length ? Math.min(...years) : 1950;
      const max = years.length ? Math.max(...years) : new Date().getFullYear();
      $('yearSlider').min = min; $('yearSlider').max = max; $('yearSlider').value = min; $('yearLabel').textContent = min;
      render(min);
      statusEl.textContent = `${statusEl.textContent} • Plotted ${built} point(s).`;
    }

    async function loadCSVFromServer(){
      try {
        statusEl.textContent = 'Loading data.csv…';
        const res = await fetch('data.csv?cb=' + Date.now(), { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').replace(/^﻿/, '').trim()
        });
        if (parsed.errors && parsed.errors.length) { console.warn(parsed.errors); }
        const rows = parsed.data || [];
        const n = rows.length;
        buildMarkers(rows);
        statusEl.textContent = `Loaded ${n} row(s).`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Could not load data.csv.';
        if (ENABLE_FILE_PICKER) $('file').classList.remove('hidden');
      }
    }

    $('file').addEventListener('change', e => {
      const file = e.target.files[0]; if(!file) return;
      statusEl.textContent = 'Parsing…';
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        transformHeader: h => (h || '').replace(/^﻿/, '').trim(),
        complete: res => {
          const rows = res.data || [];
          buildMarkers(rows);
          statusEl.textContent = `Loaded ${rows.length} row(s) from file.`;
        }
      });
    });

    $('btnReload').addEventListener('click', loadCSVFromServer);

    // Initial load
    if (ENABLE_FILE_PICKER && location.protocol === 'file:') {
      statusEl.textContent = 'Opened from file:// — use “Choose File” or run a local server.';
      $('file').classList.remove('hidden');
    } else {
      loadCSVFromServer();
    }
  </script>
</body>
</html>
